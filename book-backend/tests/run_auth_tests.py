#!/usr/bin/env python3\n\"\"\"\nComprehensive authentication system test runner and validator.\n\"\"\"\n\nimport os\nimport sys\nimport subprocess\nimport time\nimport json\nfrom pathlib import Path\nfrom typing import Dict, List, Any\n\n# Add src to path\nsys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))\n\n\nclass AuthTestRunner:\n    \"\"\"Comprehensive authentication test runner.\"\"\"\n    \n    def __init__(self):\n        self.test_results = {}\n        self.total_tests = 0\n        self.passed_tests = 0\n        self.failed_tests = 0\n        self.skipped_tests = 0\n        \n        # Test categories\n        self.test_categories = {\n            \"unit_tests\": [\n                \"tests/auth/test_error_handling.py\",\n                \"tests/security/test_security_middleware.py\",\n            ],\n            \"integration_tests\": [\n                \"tests/auth/test_authentication_flows.py\",\n                \"tests/auth/test_integration.py\",\n            ],\n            \"security_tests\": [\n                \"tests/security/test_input_validation.py\",\n                \"tests/security/test_rate_limiting.py\",\n            ],\n            \"performance_tests\": [\n                \"tests/performance/test_auth_performance.py\",\n            ]\n        }\n    \n    def run_all_tests(self) -> Dict[str, Any]:\n        \"\"\"Run all authentication tests.\"\"\"\n        print(\"ğŸ” Starting Comprehensive Authentication Test Suite\")\n        print(\"=\" * 60)\n        \n        start_time = time.time()\n        \n        # Run tests by category\n        for category, test_files in self.test_categories.items():\n            print(f\"\\nğŸ“‹ Running {category.replace('_', ' ').title()}...\")\n            self._run_test_category(category, test_files)\n        \n        # Run additional validation\n        print(\"\\nğŸ” Running Additional Validations...\")\n        self._run_security_validation()\n        self._run_configuration_validation()\n        \n        end_time = time.time()\n        total_time = end_time - start_time\n        \n        # Generate report\n        report = self._generate_report(total_time)\n        \n        # Print summary\n        self._print_summary(report)\n        \n        return report\n    \n    def _run_test_category(self, category: str, test_files: List[str]) -> None:\n        \"\"\"Run tests in a specific category.\"\"\"\n        category_results = []\n        \n        for test_file in test_files:\n            if os.path.exists(test_file):\n                result = self._run_pytest(test_file)\n                category_results.append(result)\n            else:\n                print(f\"  âš ï¸  Test file not found: {test_file}\")\n                category_results.append({\n                    \"file\": test_file,\n                    \"status\": \"not_found\",\n                    \"passed\": 0,\n                    \"failed\": 0,\n                    \"skipped\": 0\n                })\n        \n        self.test_results[category] = category_results\n    \n    def _run_pytest(self, test_file: str) -> Dict[str, Any]:\n        \"\"\"Run pytest on a specific file.\"\"\"\n        print(f\"  ğŸ§ª Running {test_file}...\")\n        \n        try:\n            # Run pytest with JSON output\n            cmd = [\n                \"python\", \"-m\", \"pytest\", \n                test_file, \n                \"-v\", \n                \"--tb=short\",\n                \"--json-report\",\n                \"--json-report-file=test_report.json\"\n            ]\n            \n            result = subprocess.run(\n                cmd, \n                capture_output=True, \n                text=True, \n                timeout=300  # 5 minute timeout\n            )\n            \n            # Parse results\n            if os.path.exists(\"test_report.json\"):\n                with open(\"test_report.json\", \"r\") as f:\n                    report_data = json.load(f)\n                \n                passed = report_data.get(\"summary\", {}).get(\"passed\", 0)\n                failed = report_data.get(\"summary\", {}).get(\"failed\", 0)\n                skipped = report_data.get(\"summary\", {}).get(\"skipped\", 0)\n                \n                os.remove(\"test_report.json\")\n            else:\n                # Fallback parsing\n                output = result.stdout + result.stderr\n                passed = output.count(\" PASSED\")\n                failed = output.count(\" FAILED\")\n                skipped = output.count(\" SKIPPED\")\n            \n            self.total_tests += passed + failed + skipped\n            self.passed_tests += passed\n            self.failed_tests += failed\n            self.skipped_tests += skipped\n            \n            status = \"passed\" if result.returncode == 0 else \"failed\"\n            \n            if status == \"passed\":\n                print(f\"    âœ… {passed} passed, {skipped} skipped\")\n            else:\n                print(f\"    âŒ {passed} passed, {failed} failed, {skipped} skipped\")\n                if result.stderr:\n                    print(f\"    Error: {result.stderr[:200]}...\")\n            \n            return {\n                \"file\": test_file,\n                \"status\": status,\n                \"passed\": passed,\n                \"failed\": failed,\n                \"skipped\": skipped,\n                \"output\": result.stdout,\n                \"error\": result.stderr\n            }\n            \n        except subprocess.TimeoutExpired:\n            print(f\"    â° Test timed out: {test_file}\")\n            return {\n                \"file\": test_file,\n                \"status\": \"timeout\",\n                \"passed\": 0,\n                \"failed\": 1,\n                \"skipped\": 0\n            }\n        except Exception as e:\n            print(f\"    ğŸ’¥ Test execution failed: {e}\")\n            return {\n                \"file\": test_file,\n                \"status\": \"error\",\n                \"passed\": 0,\n                \"failed\": 1,\n                \"skipped\": 0,\n                \"error\": str(e)\n            }\n    \n    def _run_security_validation(self) -> None:\n        \"\"\"Run security-specific validations.\"\"\"\n        print(\"  ğŸ”’ Validating security configuration...\")\n        \n        try:\n            from src.security.security_config import get_security_manager\n            \n            security_manager = get_security_manager()\n            warnings = security_manager.warnings\n            \n            if warnings:\n                print(f\"    âš ï¸  Security warnings found: {len(warnings)}\")\n                for warning in warnings[:3]:  # Show first 3\n                    print(f\"      - {warning}\")\n            else:\n                print(\"    âœ… Security configuration validated\")\n            \n            # Test security features\n            print(\"  ğŸ›¡ï¸  Testing security features...\")\n            \n            # Test input validation\n            from src.security.input_validation import InputValidator\n            \n            # Test XSS protection\n            malicious_input = \"<script>alert('xss')</script>\"\n            sanitized = InputValidator.sanitize_string(malicious_input)\n            if \"<script>\" not in sanitized:\n                print(\"    âœ… XSS protection working\")\n            else:\n                print(\"    âŒ XSS protection failed\")\n            \n            # Test SQL injection protection\n            sql_injection = \"'; DROP TABLE users; --\"\n            is_safe, _ = InputValidator.validate_sql_query_safety(sql_injection)\n            if not is_safe:\n                print(\"    âœ… SQL injection protection working\")\n            else:\n                print(\"    âŒ SQL injection protection failed\")\n            \n            # Test password validation\n            weak_password = \"password123\"\n            is_strong, errors = InputValidator.validate_password(weak_password)\n            if not is_strong and len(errors) > 0:\n                print(\"    âœ… Password validation working\")\n            else:\n                print(\"    âŒ Password validation failed\")\n                \n        except Exception as e:\n            print(f\"    ğŸ’¥ Security validation failed: {e}\")\n    \n    def _run_configuration_validation(self) -> None:\n        \"\"\"Run configuration validations.\"\"\"\n        print(\"  âš™ï¸  Validating configuration...\")\n        \n        try:\n            # Check environment variables\n            required_env_vars = [\n                \"JWT_SECRET_KEY\",\n                \"DATABASE_URL\",\n            ]\n            \n            missing_vars = []\n            for var in required_env_vars:\n                if not os.getenv(var):\n                    missing_vars.append(var)\n            \n            if missing_vars:\n                print(f\"    âš ï¸  Missing environment variables: {', '.join(missing_vars)}\")\n            else:\n                print(\"    âœ… Environment variables configured\")\n            \n            # Check file permissions\n            sensitive_files = [\n                \"src/auth/better_auth.py\",\n                \"src/security/security_config.py\",\n            ]\n            \n            for file_path in sensitive_files:\n                if os.path.exists(file_path):\n                    file_stat = os.stat(file_path)\n                    # Check if file is readable by others (basic check)\n                    if file_stat.st_mode & 0o044:  # Others can read\n                        print(f\"    âš ï¸  File {file_path} may be too permissive\")\n                else:\n                    print(f\"    âš ï¸  Sensitive file not found: {file_path}\")\n            \n            print(\"    âœ… Configuration validation completed\")\n            \n        except Exception as e:\n            print(f\"    ğŸ’¥ Configuration validation failed: {e}\")\n    \n    def _generate_report(self, total_time: float) -> Dict[str, Any]:\n        \"\"\"Generate comprehensive test report.\"\"\"\n        return {\n            \"summary\": {\n                \"total_tests\": self.total_tests,\n                \"passed_tests\": self.passed_tests,\n                \"failed_tests\": self.failed_tests,\n                \"skipped_tests\": self.skipped_tests,\n                \"success_rate\": (self.passed_tests / max(self.total_tests, 1)) * 100,\n                \"total_time\": total_time\n            },\n            \"categories\": self.test_results,\n            \"timestamp\": time.time(),\n            \"environment\": {\n                \"python_version\": sys.version,\n                \"platform\": sys.platform,\n                \"working_directory\": os.getcwd()\n            }\n        }\n    \n    def _print_summary(self, report: Dict[str, Any]) -> None:\n        \"\"\"Print test summary.\"\"\"\n        summary = report[\"summary\"]\n        \n        print(\"\\n\" + \"=\" * 60)\n        print(\"ğŸ“Š TEST SUMMARY\")\n        print(\"=\" * 60)\n        \n        print(f\"Total Tests:     {summary['total_tests']}\")\n        print(f\"Passed:          {summary['passed_tests']} âœ…\")\n        print(f\"Failed:          {summary['failed_tests']} âŒ\")\n        print(f\"Skipped:         {summary['skipped_tests']} â­ï¸\")\n        print(f\"Success Rate:    {summary['success_rate']:.1f}%\")\n        print(f\"Total Time:      {summary['total_time']:.2f} seconds\")\n        \n        # Category breakdown\n        print(\"\\nğŸ“‹ CATEGORY BREAKDOWN:\")\n        for category, results in report[\"categories\"].items():\n            total_passed = sum(r[\"passed\"] for r in results)\n            total_failed = sum(r[\"failed\"] for r in results)\n            total_skipped = sum(r[\"skipped\"] for r in results)\n            \n            print(f\"  {category.replace('_', ' ').title()}:\")\n            print(f\"    Passed: {total_passed}, Failed: {total_failed}, Skipped: {total_skipped}\")\n        \n        # Overall status\n        if summary[\"failed_tests\"] == 0:\n            print(\"\\nğŸ‰ ALL TESTS PASSED! Authentication system is ready.\")\n        elif summary[\"success_rate\"] >= 80:\n            print(\"\\nâš ï¸  Most tests passed, but some issues need attention.\")\n        else:\n            print(\"\\nâŒ Significant test failures. Please review and fix issues.\")\n        \n        print(\"\\n\" + \"=\" * 60)\n    \n    def save_report(self, report: Dict[str, Any], filename: str = \"auth_test_report.json\") -> None:\n        \"\"\"Save test report to file.\"\"\"\n        with open(filename, \"w\") as f:\n            json.dump(report, f, indent=2)\n        print(f\"\\nğŸ“„ Test report saved to: {filename}\")\n\n\ndef main():\n    \"\"\"Main test runner function.\"\"\"\n    runner = AuthTestRunner()\n    \n    try:\n        report = runner.run_all_tests()\n        runner.save_report(report)\n        \n        # Exit with appropriate code\n        if report[\"summary\"][\"failed_tests\"] == 0:\n            sys.exit(0)  # Success\n        else:\n            sys.exit(1)  # Failure\n            \n    except KeyboardInterrupt:\n        print(\"\\n\\nâ¹ï¸  Test run interrupted by user\")\n        sys.exit(130)\n    except Exception as e:\n        print(f\"\\n\\nğŸ’¥ Test runner failed: {e}\")\n        sys.exit(1)\n\n\nif __name__ == \"__main__\":\n    main()\n"