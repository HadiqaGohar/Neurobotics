"""
Security integration module for FastAPI application.
"""

import logging
from typing import Optional
from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse
from src.middleware.security_middleware import (\n    ComprehensiveSecurityMiddleware,\n    CSRFProtectionMiddleware,\n    HTTPSRedirectMiddleware\n)\nfrom src.middleware.auth_middleware import (\n    EnhancedAuthMiddleware,\n    SessionSecurityMiddleware\n)\nfrom src.middleware.error_handler import ErrorHandlingMiddleware, SecurityMiddleware\nfrom src.security.security_config import get_security_manager, SecurityConfig\nfrom src.security.input_validation import InputValidator\n\nlogger = logging.getLogger(__name__)\n\n\ndef setup_security_middleware(app: FastAPI, config: Optional[SecurityConfig] = None) -> None:\n    \"\"\"Set up comprehensive security middleware for the FastAPI application.\"\"\"\n    \n    security_manager = get_security_manager()\n    if config:\n        security_manager.config = config\n    \n    logger.info(f\"Setting up security with level: {security_manager.config.security_level}\")\n    \n    # 1. HTTPS Redirect Middleware (first in chain)\n    if security_manager.config.enable_https_only:\n        app.add_middleware(\n            HTTPSRedirectMiddleware,\n            enforce_https=security_manager.config.is_production()\n        )\n        logger.info(\"HTTPS redirect middleware enabled\")\n    \n    # 2. Error Handling Middleware\n    app.add_middleware(ErrorHandlingMiddleware)\n    logger.info(\"Error handling middleware enabled\")\n    \n    # 3. Comprehensive Security Middleware\n    middleware_config = security_manager.get_middleware_config()\n    app.add_middleware(\n        ComprehensiveSecurityMiddleware,\n        config=middleware_config\n    )\n    logger.info(\"Comprehensive security middleware enabled\")\n    \n    # 4. CSRF Protection Middleware\n    if security_manager.config.enable_csrf_protection:\n        app.add_middleware(\n            CSRFProtectionMiddleware,\n            secret_key=security_manager.config.jwt_secret_key\n        )\n        logger.info(\"CSRF protection middleware enabled\")\n    \n    # 5. Enhanced Authentication Middleware\n    auth_config = security_manager.get_auth_config()\n    app.add_middleware(\n        EnhancedAuthMiddleware,\n        config=auth_config\n    )\n    logger.info(\"Enhanced authentication middleware enabled\")\n    \n    # 6. Session Security Middleware\n    if security_manager.config.enable_session_tracking:\n        app.add_middleware(SessionSecurityMiddleware)\n        logger.info(\"Session security middleware enabled\")\n    \n    # 7. Legacy Security Middleware (for compatibility)\n    app.add_middleware(SecurityMiddleware)\n    logger.info(\"Legacy security middleware enabled\")\n\n\ndef setup_security_exception_handlers(app: FastAPI) -> None:\n    \"\"\"Set up security-related exception handlers.\"\"\"\n    \n    @app.exception_handler(429)\n    async def rate_limit_handler(request: Request, exc):\n        \"\"\"Handle rate limit exceeded errors.\"\"\"\n        return JSONResponse(\n            status_code=429,\n            content={\n                \"detail\": \"Rate limit exceeded. Please try again later.\",\n                \"error_code\": \"RATE_LIMIT_EXCEEDED\",\n                \"retry_after\": 60\n            },\n            headers={\"Retry-After\": \"60\"}\n        )\n    \n    @app.exception_handler(403)\n    async def forbidden_handler(request: Request, exc):\n        \"\"\"Handle forbidden access errors.\"\"\"\n        return JSONResponse(\n            status_code=403,\n            content={\n                \"detail\": \"Access forbidden. Insufficient permissions.\",\n                \"error_code\": \"ACCESS_FORBIDDEN\"\n            }\n        )\n    \n    @app.exception_handler(401)\n    async def unauthorized_handler(request: Request, exc):\n        \"\"\"Handle unauthorized access errors.\"\"\"\n        return JSONResponse(\n            status_code=401,\n            content={\n                \"detail\": \"Authentication required. Please log in.\",\n                \"error_code\": \"AUTHENTICATION_REQUIRED\"\n            },\n            headers={\"WWW-Authenticate\": \"Bearer\"}\n        )\n    \n    logger.info(\"Security exception handlers configured\")\n\n\ndef setup_security_endpoints(app: FastAPI) -> None:\n    \"\"\"Set up security-related endpoints.\"\"\"\n    \n    @app.get(\"/security/status\")\n    async def security_status():\n        \"\"\"Get security configuration status.\"\"\"\n        security_manager = get_security_manager()\n        return security_manager.get_security_report()\n    \n    @app.get(\"/security/health\")\n    async def security_health():\n        \"\"\"Security health check endpoint.\"\"\"\n        security_manager = get_security_manager()\n        warnings = security_manager.warnings\n        \n        return {\n            \"status\": \"healthy\" if not warnings else \"warning\",\n            \"security_level\": security_manager.config.security_level,\n            \"warnings\": warnings,\n            \"features_enabled\": {\n                \"rate_limiting\": security_manager.config.enable_rate_limiting,\n                \"csrf_protection\": security_manager.config.enable_csrf_protection,\n                \"security_headers\": security_manager.config.enable_security_headers,\n                \"https_only\": security_manager.config.enable_https_only,\n                \"input_sanitization\": security_manager.config.enable_input_sanitization,\n            }\n        }\n    \n    logger.info(\"Security endpoints configured\")\n\n\ndef validate_security_configuration() -> None:\n    \"\"\"Validate security configuration and log warnings.\"\"\"\n    security_manager = get_security_manager()\n    warnings = security_manager.warnings\n    \n    if warnings:\n        logger.warning(\"Security configuration warnings detected:\")\n        for warning in warnings:\n            logger.warning(f\"  - {warning}\")\n    else:\n        logger.info(\"Security configuration validation passed\")\n    \n    # Log security report\n    report = security_manager.get_security_report()\n    logger.info(f\"Security level: {report['security_level']}\")\n    logger.info(f\"Environment: {report['environment']}\")\n    \n    enabled_features = [k for k, v in report['features_enabled'].items() if v]\n    logger.info(f\"Enabled security features: {', '.join(enabled_features)}\")\n\n\ndef setup_comprehensive_security(app: FastAPI, config: Optional[SecurityConfig] = None) -> None:\n    \"\"\"Set up comprehensive security for the FastAPI application.\"\"\"\n    \n    logger.info(\"Setting up comprehensive security system...\")\n    \n    # Validate configuration\n    validate_security_configuration()\n    \n    # Set up middleware\n    setup_security_middleware(app, config)\n    \n    # Set up exception handlers\n    setup_security_exception_handlers(app)\n    \n    # Set up security endpoints\n    setup_security_endpoints(app)\n    \n    logger.info(\"Comprehensive security system setup complete\")\n\n\ndef get_security_headers() -> dict:\n    \"\"\"Get security headers for manual application.\"\"\"\n    security_manager = get_security_manager()\n    return security_manager.config.get_security_headers()\n\n\ndef validate_input_security(data: dict, validation_rules: dict) -> tuple:\n    \"\"\"Validate input data for security issues.\"\"\"\n    from src.security.input_validation import validate_request_data\n    return validate_request_data(data, validation_rules)\n\n\ndef sanitize_user_input(text: str, max_length: int = 10000, allow_html: bool = False) -> str:\n    \"\"\"Sanitize user input for security.\"\"\"\n    return InputValidator.sanitize_string(text, max_length, allow_html)\n\n\ndef check_password_strength(password: str) -> tuple:\n    \"\"\"Check password strength.\"\"\"\n    return InputValidator.validate_password(password)\n\n\ndef validate_email_security(email: str) -> tuple:\n    \"\"\"Validate email for security issues.\"\"\"\n    return InputValidator.validate_email(email)\n\n\n# Security utilities for use in other modules\n__all__ = [\n    'setup_comprehensive_security',\n    'get_security_headers',\n    'validate_input_security',\n    'sanitize_user_input',\n    'check_password_strength',\n    'validate_email_security',\n    'validate_security_configuration',\n]\n"