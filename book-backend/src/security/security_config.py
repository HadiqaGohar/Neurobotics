"""
Security configuration and management system.
"""

import os
import logging
from typing import Dict, Any, List, Optional
from pydantic import BaseSettings, validator
from enum import Enum

logger = logging.getLogger(__name__)


class SecurityLevel(str, Enum):
    \"\"\"Security levels for different environments.\"\"\"\n    LOW = \"low\"\n    MEDIUM = \"medium\"\n    HIGH = \"high\"\n    MAXIMUM = \"maximum\"\n\n\nclass SecurityConfig(BaseSettings):\n    \"\"\"Comprehensive security configuration.\"\"\"\n    \n    # Environment\n    environment: str = \"development\"\n    security_level: SecurityLevel = SecurityLevel.MEDIUM\n    \n    # Authentication & Authorization\n    jwt_secret_key: str = \"change-this-in-production\"\n    jwt_algorithm: str = \"HS256\"\n    access_token_expire_minutes: int = 30\n    refresh_token_expire_days: int = 7\n    max_login_attempts: int = 5\n    login_attempt_window_minutes: int = 15\n    \n    # Password Security\n    password_min_length: int = 8\n    password_max_length: int = 128\n    password_require_uppercase: bool = True\n    password_require_lowercase: bool = True\n    password_require_digits: bool = True\n    password_require_special: bool = True\n    password_history_count: int = 5\n    \n    # Session Security\n    session_timeout_minutes: int = 30\n    max_sessions_per_user: int = 5\n    enable_session_tracking: bool = True\n    enable_concurrent_session_limit: bool = True\n    \n    # Rate Limiting\n    enable_rate_limiting: bool = True\n    default_rate_limit: int = 100\n    default_rate_window_minutes: int = 60\n    auth_rate_limit: int = 10\n    auth_rate_window_minutes: int = 60\n    \n    # Input Validation\n    max_request_size_mb: int = 10\n    max_json_size_kb: int = 1024\n    max_string_length: int = 10000\n    enable_input_sanitization: bool = True\n    enable_sql_injection_protection: bool = True\n    enable_xss_protection: bool = True\n    \n    # File Upload Security\n    max_file_size_mb: int = 10\n    allowed_file_extensions: List[str] = ['.txt', '.pdf', '.docx', '.epub', '.md']\n    enable_file_content_scanning: bool = True\n    quarantine_suspicious_files: bool = True\n    \n    # Network Security\n    enable_https_only: bool = False\n    enable_hsts: bool = True\n    hsts_max_age_seconds: int = 31536000\n    enable_csrf_protection: bool = True\n    csrf_token_expire_minutes: int = 60\n    \n    # Security Headers\n    enable_security_headers: bool = True\n    content_security_policy: str = (\n        \"default-src 'self'; \"\n        \"script-src 'self' 'unsafe-inline' 'unsafe-eval'; \"\n        \"style-src 'self' 'unsafe-inline'; \"\n        \"img-src 'self' data: https:; \"\n        \"font-src 'self' https:; \"\n        \"connect-src 'self' https:; \"\n        \"frame-ancestors 'none';\"\n    )\n    \n    # IP Filtering\n    enable_ip_filtering: bool = False\n    blocked_ips: List[str] = []\n    allowed_ips: List[str] = []\n    enable_geoblocking: bool = False\n    blocked_countries: List[str] = []\n    \n    # Logging & Monitoring\n    enable_security_logging: bool = True\n    log_failed_attempts: bool = True\n    log_suspicious_activities: bool = True\n    enable_intrusion_detection: bool = True\n    alert_on_multiple_failures: bool = True\n    failure_threshold: int = 10\n    \n    # Encryption\n    encryption_key: str = \"change-this-in-production\"\n    enable_data_encryption: bool = False\n    enable_database_encryption: bool = False\n    \n    # Backup & Recovery\n    enable_security_backups: bool = True\n    backup_encryption_enabled: bool = True\n    backup_retention_days: int = 30\n    \n    # Compliance\n    enable_gdpr_compliance: bool = True\n    enable_audit_logging: bool = True\n    data_retention_days: int = 365\n    \n    class Config:\n        env_prefix = \"SECURITY_\"\n        case_sensitive = False\n    \n    @validator('jwt_secret_key')\n    def validate_jwt_secret(cls, v, values):\n        if values.get('environment') == 'production' and v == 'change-this-in-production':\n            raise ValueError('JWT secret key must be changed in production')\n        if len(v) < 32:\n            raise ValueError('JWT secret key must be at least 32 characters long')\n        return v\n    \n    @validator('encryption_key')\n    def validate_encryption_key(cls, v, values):\n        if values.get('environment') == 'production' and v == 'change-this-in-production':\n            raise ValueError('Encryption key must be changed in production')\n        if len(v) < 32:\n            raise ValueError('Encryption key must be at least 32 characters long')\n        return v\n    \n    @validator('security_level')\n    def adjust_settings_for_security_level(cls, v, values):\n        \"\"\"Adjust other settings based on security level.\"\"\"\n        if v == SecurityLevel.HIGH:\n            values.update({\n                'access_token_expire_minutes': 15,\n                'session_timeout_minutes': 15,\n                'max_login_attempts': 3,\n                'password_min_length': 12,\n                'enable_csrf_protection': True,\n                'enable_https_only': True,\n            })\n        elif v == SecurityLevel.MAXIMUM:\n            values.update({\n                'access_token_expire_minutes': 10,\n                'session_timeout_minutes': 10,\n                'max_login_attempts': 3,\n                'password_min_length': 16,\n                'password_require_special': True,\n                'enable_csrf_protection': True,\n                'enable_https_only': True,\n                'enable_data_encryption': True,\n                'enable_intrusion_detection': True,\n            })\n        return v\n    \n    def get_rate_limit_config(self, endpoint: str) -> Dict[str, int]:\n        \"\"\"Get rate limit configuration for specific endpoint.\"\"\"\n        endpoint_configs = {\n            '/auth/login': {\n                'max_requests': self.auth_rate_limit,\n                'window_minutes': self.auth_rate_window_minutes\n            },\n            '/auth/signup': {\n                'max_requests': max(self.auth_rate_limit // 2, 3),\n                'window_minutes': self.auth_rate_window_minutes\n            },\n            '/auth/forgot-password': {\n                'max_requests': 3,\n                'window_minutes': 60\n            },\n            '/auth/reset-password': {\n                'max_requests': 5,\n                'window_minutes': 60\n            },\n        }\n        \n        return endpoint_configs.get(endpoint, {\n            'max_requests': self.default_rate_limit,\n            'window_minutes': self.default_rate_window_minutes\n        })\n    \n    def get_password_policy(self) -> Dict[str, Any]:\n        \"\"\"Get password policy configuration.\"\"\"\n        return {\n            'min_length': self.password_min_length,\n            'max_length': self.password_max_length,\n            'require_uppercase': self.password_require_uppercase,\n            'require_lowercase': self.password_require_lowercase,\n            'require_digits': self.password_require_digits,\n            'require_special': self.password_require_special,\n            'history_count': self.password_history_count,\n        }\n    \n    def get_security_headers(self) -> Dict[str, str]:\n        \"\"\"Get security headers configuration.\"\"\"\n        headers = {}\n        \n        if self.enable_security_headers:\n            headers.update({\n                'X-Content-Type-Options': 'nosniff',\n                'X-Frame-Options': 'DENY',\n                'X-XSS-Protection': '1; mode=block',\n                'Referrer-Policy': 'strict-origin-when-cross-origin',\n                'Content-Security-Policy': self.content_security_policy,\n                'Permissions-Policy': (\n                    \"geolocation=(), microphone=(), camera=(), \"\n                    \"payment=(), usb=(), magnetometer=(), gyroscope=()\"\n                ),\n            })\n        \n        if self.enable_hsts and self.enable_https_only:\n            headers['Strict-Transport-Security'] = f'max-age={self.hsts_max_age_seconds}; includeSubDomains'\n        \n        return headers\n    \n    def is_production(self) -> bool:\n        \"\"\"Check if running in production environment.\"\"\"\n        return self.environment.lower() == 'production'\n    \n    def validate_configuration(self) -> List[str]:\n        \"\"\"Validate security configuration and return warnings.\"\"\"\n        warnings = []\n        \n        if self.is_production():\n            if self.jwt_secret_key == 'change-this-in-production':\n                warnings.append(\"JWT secret key should be changed in production\")\n            \n            if self.encryption_key == 'change-this-in-production':\n                warnings.append(\"Encryption key should be changed in production\")\n            \n            if not self.enable_https_only:\n                warnings.append(\"HTTPS should be enforced in production\")\n            \n            if self.security_level in [SecurityLevel.LOW, SecurityLevel.MEDIUM]:\n                warnings.append(\"Consider using HIGH or MAXIMUM security level in production\")\n            \n            if self.access_token_expire_minutes > 60:\n                warnings.append(\"Access token expiration time is quite long for production\")\n        \n        if self.password_min_length < 8:\n            warnings.append(\"Password minimum length should be at least 8 characters\")\n        \n        if not self.enable_rate_limiting:\n            warnings.append(\"Rate limiting should be enabled for security\")\n        \n        if not self.enable_security_headers:\n            warnings.append(\"Security headers should be enabled\")\n        \n        return warnings\n\n\nclass SecurityManager:\n    \"\"\"Security configuration manager.\"\"\"\n    \n    def __init__(self, config: Optional[SecurityConfig] = None):\n        self.config = config or SecurityConfig()\n        self.warnings = self.config.validate_configuration()\n        \n        if self.warnings:\n            for warning in self.warnings:\n                logger.warning(f\"Security configuration warning: {warning}\")\n    \n    def get_middleware_config(self) -> Dict[str, Any]:\n        \"\"\"Get configuration for security middleware.\"\"\"\n        return {\n            'enable_rate_limiting': self.config.enable_rate_limiting,\n            'enable_ip_filtering': self.config.enable_ip_filtering,\n            'enable_request_validation': True,\n            'enable_security_headers': self.config.enable_security_headers,\n            'enable_csrf_protection': self.config.enable_csrf_protection,\n            'rate_limit_requests': self.config.default_rate_limit,\n            'rate_limit_window': self.config.default_rate_window_minutes,\n            'blocked_ips': self.config.blocked_ips,\n            'allowed_ips': self.config.allowed_ips,\n        }\n    \n    def get_auth_config(self) -> Dict[str, Any]:\n        \"\"\"Get configuration for authentication.\"\"\"\n        return {\n            'jwt_secret_key': self.config.jwt_secret_key,\n            'jwt_algorithm': self.config.jwt_algorithm,\n            'access_token_expire_minutes': self.config.access_token_expire_minutes,\n            'refresh_token_expire_days': self.config.refresh_token_expire_days,\n            'max_login_attempts': self.config.max_login_attempts,\n            'login_attempt_window_minutes': self.config.login_attempt_window_minutes,\n            'session_timeout_minutes': self.config.session_timeout_minutes,\n            'max_sessions_per_user': self.config.max_sessions_per_user,\n            'password_policy': self.config.get_password_policy(),\n        }\n    \n    def get_validation_config(self) -> Dict[str, Any]:\n        \"\"\"Get configuration for input validation.\"\"\"\n        return {\n            'max_request_size_mb': self.config.max_request_size_mb,\n            'max_json_size_kb': self.config.max_json_size_kb,\n            'max_string_length': self.config.max_string_length,\n            'enable_input_sanitization': self.config.enable_input_sanitization,\n            'enable_sql_injection_protection': self.config.enable_sql_injection_protection,\n            'enable_xss_protection': self.config.enable_xss_protection,\n            'max_file_size_mb': self.config.max_file_size_mb,\n            'allowed_file_extensions': self.config.allowed_file_extensions,\n        }\n    \n    def is_endpoint_protected(self, endpoint: str) -> bool:\n        \"\"\"Check if endpoint requires special protection.\"\"\"\n        protected_patterns = [\n            '/auth/',\n            '/api/',\n            '/admin/',\n            '/user/',\n        ]\n        \n        return any(endpoint.startswith(pattern) for pattern in protected_patterns)\n    \n    def get_security_report(self) -> Dict[str, Any]:\n        \"\"\"Generate security configuration report.\"\"\"\n        return {\n            'environment': self.config.environment,\n            'security_level': self.config.security_level,\n            'warnings': self.warnings,\n            'features_enabled': {\n                'rate_limiting': self.config.enable_rate_limiting,\n                'csrf_protection': self.config.enable_csrf_protection,\n                'security_headers': self.config.enable_security_headers,\n                'https_only': self.config.enable_https_only,\n                'input_sanitization': self.config.enable_input_sanitization,\n                'session_tracking': self.config.enable_session_tracking,\n                'intrusion_detection': self.config.enable_intrusion_detection,\n            },\n            'token_settings': {\n                'access_token_expire_minutes': self.config.access_token_expire_minutes,\n                'refresh_token_expire_days': self.config.refresh_token_expire_days,\n                'session_timeout_minutes': self.config.session_timeout_minutes,\n            },\n            'password_policy': self.config.get_password_policy(),\n            'rate_limits': {\n                'default': self.config.default_rate_limit,\n                'auth': self.config.auth_rate_limit,\n            },\n        }\n\n\n# Global security manager instance\nsecurity_manager = SecurityManager()\n\n\ndef get_security_config() -> SecurityConfig:\n    \"\"\"Get the global security configuration.\"\"\"\n    return security_manager.config\n\n\ndef get_security_manager() -> SecurityManager:\n    \"\"\"Get the global security manager.\"\"\"\n    return security_manager\n"